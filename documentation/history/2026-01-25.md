# 2026-01-25

## Accomplished

### DataviewJS Support Implementation

Implemented full support for serializing DataviewJS queries to static markdown, enabling JavaScript-based Dataview queries to work with Obsidian Publish and other static rendering contexts.

**Key components added:**

1. **Constants** (`src/app/constants.ts`)
    - Added DataviewJS marker constants for both legacy and alternative syntax variants
    - Added 5-second execution timeout constant

2. **DataviewJS Proxy** (`src/app/utils/dataviewjs-proxy.ts`)
    - Created proxy `dv` object that intercepts rendering calls
    - Captures `dv.list()`, `dv.table()`, `dv.taskList()`, `dv.paragraph()`, `dv.header()`, `dv.span()`, `dv.el()`, `dv.execute()` output
    - `dv.el()` converts HTML elements to markdown (p, div, h1-h6, b, strong, i, em, code, pre, a, img, br, hr, blockquote, li, etc.)
    - `dv.execute()` delegates to `queryMarkdown()` and captures the result
    - Passes through read-only methods to real Dataview API
    - Passthrough methods include: `clone`, `parse`, `tryEvaluate`, `markdownTable`, `markdownList`, `markdownTaskList`
    - Converts captured output to markdown

3. **Query Detection** (`src/app/utils/find-dataviewjs-queries.fn.ts`)
    - Detects DataviewJS queries in both legacy and alternative syntax
    - Handles multi-line JavaScript code
    - Returns `DataviewJSQueryWithContext` objects with update mode, syntax variant

4. **Serialization** (`src/app/utils/serialize-dataviewjs-query.fn.ts`)
    - Executes JavaScript code with proxy `dv` object
    - Supports async/await using `AsyncFunction` constructor
    - Implements 5-second execution timeout

5. **Plugin Integration** (`src/app/plugin.ts`)
    - Added `enableDataviewJS` setting loading
    - Added `processDataviewJSQueries()` method
    - Integrated DataviewJS processing into `processFile()` flow

6. **Settings**
    - Added `enableDataviewJS` setting (default: `true`)
    - Added toggle in settings tab

7. **Editor Extension** (`src/app/refresh-button-extension.ts`)
    - Added DataviewJS query line decorations
    - Added DataviewJS result marker decorations

**Syntax variants:**

Legacy:

```markdown
<!-- DataviewJSToSerialize:
dv.list(dv.pages("#project").file.link)
-->
<!-- SerializedDataviewJS -->

...

<!-- SerializedDataviewJS END -->
```

Alternative:

```markdown
<!-- dataview-serializer-js:
dv.list(dv.pages("#project").file.link)
-->
<!-- dataview-serializer-js-result -->

...

<!-- dataview-serializer-js-result-end -->
```

**Tests added:**

- `find-dataviewjs-queries.fn.spec.ts` - 21 tests for query detection
- `dataviewjs-proxy.spec.ts` - 45 tests for proxy functionality (rendering methods, Link objects, special types, io methods, utility methods, query methods, markdown generation)

**Documentation updated:**

- `AGENTS.md` - Added DataviewJS syntax reference

## Key Decisions

1. Used HTML comment syntax consistent with existing block/inline queries
2. Proxy-based capture approach (intercept rendering calls) rather than DOM parsing
3. 5-second hardcoded timeout (can be made configurable later)
4. Task checkboxes stripped to prevent feedback loops (consistent with regular TASK queries)
5. `dv.el()` converts common HTML elements to markdown equivalents
6. `dv.execute()` delegates to `queryMarkdown()` and captures output
7. `dv.view()`, `dv.executeJs()` not supported (require external files/nested execution)

## Known Limitations

1. JavaScript code cannot contain `--` due to HTML comment restrictions
2. `dv.view()` not supported (external template files require file system access)
3. `dv.executeJs()` not supported (nested execution not allowed)
